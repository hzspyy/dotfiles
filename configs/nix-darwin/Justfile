# =============================================================================
#  Nix-Darwin Control Center
# =============================================================================

# Configuration
hostname := "smc-mac"
flake_path := "."

# Colors
green := `tput setaf 2`
blue := `tput setaf 4`
bold := `tput bold`
reset := `tput sgr0`

# Default: List available commands
default:
    @just --list --unsorted

# =============================================================================
#  ğŸ System Management
# =============================================================================

# Apply the current configuration to the system
[group('System')]
switch:
    @echo "{{bold}}{{blue}}==> Rebuilding system for {{hostname}}...{{reset}}"
    sudo nix run nix-darwin -- switch --flake {{flake_path}}#{{hostname}}
    @echo "{{bold}}{{green}}==> System updated successfully! ğŸ{{reset}}"

# Debug build (verbose output)
[group('System')]
debug:
    @echo "{{bold}}{{blue}}==> Debugging build...{{reset}}"
    nix build {{flake_path}}#darwinConfigurations.{{hostname}}.system --show-trace --verbose --extra-experimental-features 'nix-command flakes'
    sudo -E ./result/sw/bin/darwin-rebuild switch --flake {{flake_path}}#{{hostname}} --show-trace --verbose

# =============================================================================
#  ğŸº Homebrew Shortcuts (The Magic Part)
# =============================================================================

# Install a Brew package, add to config, and format
[group('Homebrew')]
add name:
    @echo "{{bold}}{{blue}}==> 1. Installing {{name}} immediately (for now)...{{reset}}"
    @brew install {{name}} || true
    @echo "{{bold}}{{blue}}==> 2. Persisting {{name}} to homebrew.nix (for later)...{{reset}}"
    @# è¿™ä¸€æ­¥å°†è½¯ä»¶åæ’å…¥åˆ° 'brews = [' çš„ä¸‹ä¸€è¡Œ
    @perl -pi -e 's/brews = \[/brews = \[\n      "{{name}}"/g' homebrew.nix
    @echo "{{bold}}{{blue}}==> 3. Formatting file...{{reset}}"
    @nix fmt homebrew.nix
    @echo "{{bold}}{{green}}==> Done! {{name}} is installed and saved. ğŸº{{reset}}"

# Install a Cask app, add to config, and format
[group('Homebrew')]
cask name:
    @echo "{{bold}}{{blue}}==> 1. Installing Cask {{name}} immediately...{{reset}}"
    @brew install --cask {{name}} || true
    @echo "{{bold}}{{blue}}==> 2. Persisting {{name}} to homebrew.nix...{{reset}}"
    @# è¿™ä¸€æ­¥å°†è½¯ä»¶åæ’å…¥åˆ° 'casks = [' çš„ä¸‹ä¸€è¡Œ
    @perl -pi -e 's/casks = \[/casks = \[\n      "{{name}}"/g' homebrew.nix
    @echo "{{bold}}{{blue}}==> 3. Formatting file...{{reset}}"
    @nix fmt homebrew.nix  
    @echo "{{bold}}{{green}}==> Done! {{name}} is installed and saved. ğŸ–¥ï¸{{reset}}"

# =============================================================================
#  â„ï¸ Nix Maintenance
# =============================================================================

# Update flake inputs
[group('Nix')]
update:
    @echo "{{bold}}{{blue}}==> Updating flake inputs...{{reset}}"
    nix flake update

# Update a specific input (Usage: just up <input>)
[group('Nix')]
up input:
    nix flake update {{input}}

# Open a REPL with nixpkgs loaded
[group('Nix')]
repl:
    nix repl -f flake:nixpkgs

# Format all Nix files
[group('Nix')]
fmt:
    nix fmt

# =============================================================================
#  ğŸ§¹ Cleanup
# =============================================================================

# Garbage collect and remove old generations (>7d)
[group('Cleanup')]
clean:
    @echo "{{bold}}{{blue}}==> Cleaning up old generations...{{reset}}"
    sudo nix profile wipe-history --profile /nix/var/nix/profiles/system --older-than 7d
    @echo "{{bold}}{{blue}}==> Collecting garbage...{{reset}}"
    sudo nix-collect-garbage --delete-older-than 7d
    nix-collect-garbage --delete-older-than 7d
    @echo "{{bold}}{{green}}==> System Cleaned! ğŸ§¹{{reset}}"

